# 微信小程序发布指南

本文档详细介绍如何将寻源家谱小程序发布到微信平台。

---

## 📋 目录

1. [发布前准备](#1-发布前准备)
2. [注册微信小程序](#2-注册微信小程序)
3. [配置服务器域名](#3-配置服务器域名)
4. [构建生产版本](#4-构建生产版本)
5. [上传代码](#5-上传代码)
6. [提交审核](#6-提交审核)
7. [发布上线](#7-发布上线)
8. [常见问题](#8-常见问题)

---

## 1. 发布前准备

### 1.1 检查清单

在发布前，请确保完成以下事项：

- [ ] 后端 API 已部署到生产服务器
- [ ] 后端域名已配置 HTTPS（必须）
- [ ] 后端域名已完成 ICP 备案
- [ ] 准备好小程序的 Logo（108×108 像素）
- [ ] 准备好小程序的介绍文案
- [ ] 准备好小程序的分类信息
- [ ] 如涉及特殊类目，准备好相关资质证明

### 1.2 环境要求

- Node.js >= 16
- [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)（最新稳定版）
- 稳定的网络连接

### 1.3 更新生产环境配置

编辑 `.env.production` 文件：

```bash
# 生产环境 API 地址（必须是 HTTPS）
TARO_APP_API_BASE_URL=https://your-domain.com/api
```

---

## 2. 注册微信小程序

### 2.1 注册账号

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击「立即注册」
3. 选择「小程序」类型
4. 按照指引完成注册：
   - 填写邮箱和密码
   - 邮箱验证
   - 选择主体类型（个人/企业/组织）
   - 填写主体信息
   - 管理员身份验证

### 2.2 获取 AppID

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发管理」→「开发设置」
3. 复制「AppID(小程序ID)」

### 2.3 配置项目 AppID

编辑 `project.config.json`：

```json
{
  "appid": "wx1234567890abcdef",  // 替换为你的 AppID
  "projectname": "XunYuanMiniPro"
}
```

---

## 3. 配置服务器域名

### 3.1 进入域名配置

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发管理」→「开发设置」→「服务器域名」
3. 点击「开始配置」（首次需要管理员扫码验证）

### 3.2 配置各类域名

根据你的后端服务配置以下域名：

| 域名类型 | 用途 | 示例 |
|---------|------|------|
| `request 合法域名` | API 请求 | `https://api.your-domain.com` |
| `uploadFile 合法域名` | 文件上传 | `https://api.your-domain.com` |
| `downloadFile 合法域名` | 图片下载 | `https://api.your-domain.com` |

### 3.3 域名要求

- ✅ 必须是 HTTPS 协议
- ✅ 域名必须已完成 ICP 备案
- ❌ 不支持 IP 地址
- ❌ 不支持 localhost

### 3.4 验证域名配置

配置完成后，可以在开发者工具中测试：
1. 关闭「不校验合法域名」选项
2. 尝试登录或其他 API 调用
3. 确认请求正常通过

---

## 4. 构建生产版本

### 4.1 安装依赖

```bash
cd XunYuanMiniPro
npm install
```

### 4.2 构建小程序代码

```bash
npm run build:weapp
```

构建成功后，会在 `dist` 目录生成小程序代码：

```
dist/
├── app.js
├── app.json
├── app.wxss
├── pages/
│   ├── index/
│   ├── login/
│   ├── family/
│   └── mine/
└── project.config.json
```

### 4.3 验证构建结果

检查以下内容：
- [ ] `dist/app.json` 包含正确的页面路径
- [ ] `dist/project.config.json` 包含正确的 AppID
- [ ] 无编译错误或警告

---

## 5. 上传代码

### 5.1 打开微信开发者工具

1. 启动微信开发者工具
2. 选择「导入项目」
3. 项目目录选择 `XunYuanMiniPro`（不是 dist 目录）
4. AppID 会自动从 `project.config.json` 读取

### 5.2 预览和调试

1. **模拟器调试**：在工具中直接测试各功能
2. **真机预览**：
   - 点击「预览」按钮
   - 扫描二维码在手机上测试
   - 测试所有功能是否正常

### 5.3 上传代码

1. 点击工具栏的「上传」按钮
2. 填写版本信息：
   - **版本号**：如 `1.0.0`
   - **项目备注**：如 `首次发布版本`
3. 点击「上传」确认

上传成功后，代码会进入「开发版本」。

### 5.4 测试开发版本

1. 登录微信公众平台
2. 进入「管理」→「版本管理」
3. 在「开发版本」中可以：
   - 选为体验版（供测试人员体验）
   - 查看详情
   - 删除版本

---

## 6. 提交审核

### 6.1 设置体验版（可选）

1. 在「版本管理」→「开发版本」中
2. 点击「选为体验版」
3. 添加体验成员（最多100人）
4. 让团队成员充分测试

### 6.2 提交审核

1. 确认测试无问题后，点击「提交审核」
2. 填写审核信息：
   - **页面路径**：选择小程序首页路径
   - **版本描述**：描述本次更新内容
   - **类目选择**：选择合适的服务类目
   - **用户隐私保护说明**：如有涉及，需填写

### 6.3 审核注意事项

**常见审核不通过原因：**

| 问题 | 解决方案 |
|------|---------|
| 页面空白或加载失败 | 确保后端服务正常，域名配置正确 |
| 功能不完整 | 确保所有功能可正常使用 |
| 内容违规 | 检查是否有敏感词或违规内容 |
| 类目不符 | 选择正确的服务类目 |
| 缺少资质 | 准备相关资质证明文件 |
| 诱导分享 | 避免强制分享才能使用的功能 |
| 虚假信息 | 确保介绍与实际功能一致 |

### 6.4 审核周期

- 普通审核：1-7 个工作日
- 加急审核：24 小时内（需满足条件）

---

## 7. 发布上线

### 7.1 审核通过

审核通过后，会收到微信通知。此时版本会进入「审核版本」。

### 7.2 发布版本

1. 登录微信公众平台
2. 进入「管理」→「版本管理」
3. 在「审核版本」中点击「发布」
4. 确认发布

### 7.3 发布选项

| 选项 | 说明 |
|------|------|
| 全量发布 | 立即对所有用户生效 |
| 分阶段发布 | 按比例逐步发布（如 10% → 50% → 100%） |

### 7.4 发布后检查

1. 在微信中搜索你的小程序
2. 测试所有功能是否正常
3. 检查数据是否正常上报

---

## 8. 常见问题

### Q1: 真机预览时网络请求失败？

**原因**：开发版本默认会校验域名

**解决方案**：
1. 在微信开发者工具中：「详情」→「本地设置」→ 勾选「不校验合法域名」
2. 或者：正确配置服务器域名（推荐）

### Q2: 上传时提示「项目未关联 AppID」？

**解决方案**：
1. 检查 `project.config.json` 中的 `appid` 是否正确
2. 确认该 AppID 对应的小程序已注册

### Q3: 审核一直不通过怎么办？

**解决方案**：
1. 仔细阅读审核反馈
2. 逐项修改对应问题
3. 重新提交审核
4. 如有疑问，可申诉或联系客服

### Q4: 如何更新已发布的小程序？

**流程**：
1. 本地修改代码
2. `npm run build:weapp` 构建
3. 微信开发者工具上传新版本
4. 提交审核
5. 审核通过后发布

### Q5: 小程序包体积太大怎么办？

**解决方案**：
1. 启用分包加载
2. 压缩图片资源
3. 删除无用代码和依赖
4. 使用 CDN 加载静态资源

### Q6: 如何查看小程序运营数据？

**方法**：
1. 登录微信公众平台
2. 进入「统计」模块
3. 可查看：
   - 访问数据
   - 用户画像
   - 页面分析
   - 事件分析

---

## 📞 技术支持

如遇到问题，可通过以下方式获取帮助：

- 📖 [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- 💬 [微信开放社区](https://developers.weixin.qq.com/community/develop/mixflow)
- 📧 应用内「意见反馈」功能

---

## 📋 发布检查清单

```
发布前检查：
[ ] 后端 API 正常运行
[ ] HTTPS 证书有效
[ ] 域名已配置到公众平台
[ ] AppID 配置正确
[ ] 生产环境变量已更新
[ ] 所有功能测试通过

上传前检查：
[ ] npm run build:weapp 无错误
[ ] 体验版测试通过
[ ] 版本号已更新

审核前检查：
[ ] 页面路径填写正确
[ ] 类目选择合适
[ ] 隐私政策已更新

发布后检查：
[ ] 小程序可正常搜索
[ ] 所有功能正常
[ ] 数据正常上报
```

---

*最后更新：2026-01-19*
